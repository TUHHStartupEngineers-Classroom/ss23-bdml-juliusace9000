{
  "hash": "c85cebb63e27265b2774cd821a151f9e",
  "result": {
    "markdown": "---\ntitle: \"Supervised ML Regression\"\nauthor: \"Julius von Sulecki\"\noutput:\n  html_document:\n    toc: TRUE\n    theme: united\n---\n\nThe second challenge/businesscase\n\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-1_2980f3aca506fd7c834aeff4d274f6e2'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(parsnip)\nlibrary(recipes)\nlibrary(rsample)\nlibrary(yardstick)\nlibrary(rpart.plot)\n```\n:::\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-2_6b1383284f58bc477b5ab3ecc13a0a43'}\n\n```{.r .cell-code}\n# Modeling ----------------------------------------------------------------\nbike_orderlines_tbl <- readRDS(\"bike_orderlines.rds\")\nglimpse(bike_orderlines_tbl)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Rows: 15,644\n#> Columns: 18\n#> $ order_id       <dbl> 1, 1, 2, 2, 3, 3, 3, 3, 3, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7~\n#> $ order_line     <dbl> 1, 2, 1, 2, 1, 2, 3, 4, 5, 1, 1, 2, 3, 4, 1, 2, 3, 4, 1~\n#> $ order_date     <dttm> 2015-01-07, 2015-01-07, 2015-01-10, 2015-01-10, 2015-0~\n#> $ model          <chr> \"Spectral CF 7 WMN\", \"Ultimate CF SLX Disc 8.0 ETAP\", \"~\n#> $ model_year     <dbl> 2021, 2020, 2021, 2019, 2020, 2020, 2020, 2021, 2020, 2~\n#> $ category_1     <chr> \"Mountain\", \"Road\", \"Mountain\", \"Road\", \"Mountain\", \"Hy~\n#> $ category_2     <chr> \"Trail\", \"Race\", \"Trail\", \"Triathlon Bike\", \"Dirt Jump\"~\n#> $ category_3     <chr> \"Spectral\", \"Ultimate\", \"Neuron\", \"Speedmax\", \"Stitched~\n#> $ price          <dbl> 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899, 6~\n#> $ quantity       <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1~\n#> $ total_price    <dbl> 3119, 5359, 2729, 1749, 1219, 1359, 2529, 1559, 3899, 6~\n#> $ frame_material <chr> \"carbon\", \"carbon\", \"carbon\", \"carbon\", \"aluminium\", \"c~\n#> $ weight         <dbl> 13.80, 7.44, 14.06, 8.80, 11.50, 8.80, 8.20, 8.85, 14.4~\n#> $ url            <chr> \"https://www.canyon.com/en-de/mountain-bikes/trail-bike~\n#> $ bikeshop       <chr> \"AlexandeRad\", \"AlexandeRad\", \"WITT-RAD\", \"WITT-RAD\", \"~\n#> $ location       <chr> \"Hamburg, Hamburg\", \"Hamburg, Hamburg\", \"Bremen, Bremen~\n#> $ lat            <dbl> 53.57532, 53.57532, 53.07379, 53.07379, 48.78234, 48.78~\n#> $ lng            <dbl> 10.015340, 10.015340, 8.826754, 8.826754, 9.180819, 9.1~\n```\n:::\n\n```{.r .cell-code}\nmodel_sales_tbl <- bike_orderlines_tbl %>%\n  select(total_price, model, category_2, frame_material) %>%\n  \n  group_by(model, category_2, frame_material) %>%\n  summarise(total_sales = sum(total_price)) %>%\n  ungroup() %>%\n  \n  arrange(desc(total_sales))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> `summarise()` has grouped output by 'model', 'category_2'. You can override\n#> using the `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\nmodel_sales_tbl %>%\n  mutate(category_2 = as_factor(category_2) %>% \n           fct_reorder(total_sales, .fun = max) %>% \n           fct_rev()) %>%\n  \n  ggplot(aes(frame_material, total_sales)) +\n  geom_violin() +\n  geom_jitter(width = 0.1, alpha = 0.5, color = \"#2c3e50\") +\n  #coord_flip() +\n  facet_wrap(~ category_2) +\n  scale_y_continuous(labels = scales::dollar_format(scale = 1e-6, suffix = \"M\", accuracy = 0.1)) +\n  tidyquant::theme_tq() +\n  labs(\n    title = \"Total Sales for Each Model\",\n    x = \"Frame Material\", y = \"Revenue\"\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Registered S3 method overwritten by 'quantmod':\n#>   method            from\n#>   as.zoo.data.frame zoo\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Groups with fewer than two data points have been dropped.\n#> Groups with fewer than two data points have been dropped.\n#> Groups with fewer than two data points have been dropped.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning in max(data$density): kein nicht-fehlendes Argument für max; gebe -Inf\n#> zurück\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Computation failed in `stat_ydensity()`\n#> Caused by error in `$<-.data.frame`:\n#> ! replacement has 1 row, data has 0\n```\n:::\n\n::: {.cell-output-display}\n![](02_supervised_ML_regression_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbike_features_tbl <- readRDS(\"bike_features_tbl.rds\")\nglimpse(bike_features_tbl)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Rows: 231\n#> Columns: 67\n#> $ bike_id                     <dbl> 2875, 2873, 2874, 2876, 2877, 2225, 2091, ~\n#> $ model                       <chr> \"Aeroad CF SL Disc 8.0 Di2\", \"Aeroad CF SL~\n#> $ model_year                  <dbl> 2020, 2020, 2020, 2020, 2020, 2019, 2019, ~\n#> $ frame_material              <chr> \"carbon\", \"carbon\", \"carbon\", \"carbon\", \"c~\n#> $ weight                      <dbl> 7.60, 7.27, 7.10, 7.73, 7.83, 6.80, 6.80, ~\n#> $ price                       <dbl> 4579, 6919, 6429, 5069, 3609, 6139, 5359, ~\n#> $ category_1                  <chr> \"Road\", \"Road\", \"Road\", \"Road\", \"Road\", \"R~\n#> $ category_2                  <chr> \"Race\", \"Race\", \"Race\", \"Race\", \"Race\", \"R~\n#> $ category_3                  <chr> \"Aeroad\", \"Aeroad\", \"Aeroad\", \"Aeroad\", \"A~\n#> $ gender                      <chr> \"unisex\", \"unisex\", \"unisex\", \"unisex\", \"u~\n#> $ url                         <chr> \"https://www.canyon.com/en-de/road-bikes/r~\n#> $ Frame                       <chr> \"Canyon Aeroad CF SL Disc\", \"Canyon Aeroad~\n#> $ Fork                        <chr> \"Canyon FK0041 CF SLX Disc\", \"Canyon FK004~\n#> $ `Rear Derailleur`           <chr> \"Shimano Ultegra Di2 R8050 SS\", \"SRAM RED ~\n#> $ `Front Derailleur`          <chr> \"Shimano Ultegra Di2 R8050\", \"SRAM RED eTa~\n#> $ Cassette                    <chr> \"Shimano Ultegra R8000, 11-speed, 11-28T\",~\n#> $ Crank                       <chr> \"Shimano Ultegra R8000\", \"SRAM RED D1\", \"S~\n#> $ `Bottom bracket`            <chr> \"Shimano Pressfit BB72\", \"SRAM Pressfit RE~\n#> $ `Thru Axle`                 <chr> \"Canyon Thru Axle\", \"Canyon Thru Axle\", \"C~\n#> $ Cockpit                     <chr> \"Canyon H36 Aerocockpit CF\", \"Canyon H36 A~\n#> $ Saddle                      <chr> \"Selle Italia SLR\", \"Selle Italia SLR\", \"S~\n#> $ Seatpost                    <chr> \"Canyon S27 Aero VCLS CF\", \"Canyon S27 Aer~\n#> $ Pedals                      <chr> \"None included\", \"None included\", \"None in~\n#> $ `Derailleur hanger`         <chr> \"Shop Derailleur Hanger GP0211-01\", \"Shop ~\n#> $ Battery                     <chr> \"\", \"SRAM eTap Powerpack\", \"\", \"SRAM eTap ~\n#> $ Brake                       <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Shift Lever`               <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"Shimano Di2 Remot~\n#> $ Chain                       <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"Shimano CN-HG901 ~\n#> $ Stem                        <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"Canyon V13\", ~\n#> $ Handlebar                   <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"Canyon H16 Ae~\n#> $ Headset                     <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Motor                       <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Battery Charger`           <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Flat Pedals`               <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Chainguard                  <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Aero Bar`                  <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Brake Lever / Master`      <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Wheel Tire System`         <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Suspension Fork`           <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Disc Brake`                <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Grips                       <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Chainring                   <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Display                     <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Modeswitch                  <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Rear Shock`                <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Light                       <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ Fender                      <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Bike Racks`                <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Brake 1`                   <chr> \"\", \"\", \"\", \"\", \"\", \"SRAM S-900 Direct Mou~\n#> $ `Brake 2`                   <chr> \"\", \"\", \"\", \"\", \"\", \"SRAM S-900 Direct Mou~\n#> $ `Shift-/ Brake Lever 1`     <chr> \"Shimano Ultegra Di2 R8070, 11-speed\", \"SR~\n#> $ `Shift-/ Brake Lever 2`     <chr> \"Shimano Ultegra Di2 R8070, 11-speed\", \"SR~\n#> $ `Wheel 1`                   <chr> \"DT Swiss ARC 1400 Dicut\", \"DT Swiss ARC 1~\n#> $ `Wheel 2`                   <chr> \"DT Swiss ARC 1400 Dicut\", \"DT Swiss ARC 1~\n#> $ `Tyre 1`                    <chr> \"Continental Grand Prix 5000 / Attack  23 ~\n#> $ `Tyre 2`                    <chr> \"Continental Grand Prix 5000, 25 mm\", \"Con~\n#> $ `Handlebar Tape 1`          <chr> \"Canyon Ergospeed Gel\", \"Canyon Ergospeed ~\n#> $ `Handlebar Tape 2`          <chr> \"Canyon bar-end plug\", \"Canyon bar-end plu~\n#> $ `Manuals and Accessories 1` <chr> \"Canyon tool case\", \"Canyon tool case\", \"C~\n#> $ `Manuals and Accessories 2` <chr> \"DT Swiss warranty & intended use manual\",~\n#> $ `Manuals and Accessories 3` <chr> \"Canyon starter box\", \"Canyon starter box\"~\n#> $ `Manuals and Accessories 4` <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"BAG R~\n#> $ `Manuals and Accessories 5` <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Manuals and Accessories 6` <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Manuals and Accessories 7` <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Manuals and Accessories 8` <chr> \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"~\n#> $ `Brake Rotor`               <list> \"Shimano RT800\", \"SRAM Centerline X\", \"Sh~\n```\n:::\n\n```{.r .cell-code}\n  # 2.0 TRAINING & TEST SETS ----\nbike_features_tbl <- bike_features_tbl %>% \n  \n  mutate(id = row_number()) %>% \n  \n  select(id, everything(), -url)\n```\n:::\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-3_481d98e30d2a16a03327169849653bd0'}\n\n```{.r .cell-code}\n# Create a recipe object\nbike_recipe <- recipe(price ~ frame_material + category_2 + model, data = bike_orderlines_tbl) %>% #Predict price from frame_material, category_2 and model\n  step_dummy(all_nominal(),-frame_material,-category_2,-model,one_hot = T) %>% #Remove all others\n  prep() #Estimate the required parameters\n```\n:::\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-4_d4424c42cb19e66264d6cfa3f98894c4'}\n\n```{.r .cell-code}\nbike_orderlines_tbl %>% distinct(category_2)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"category_2\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"Trail\"},{\"1\":\"Race\"},{\"1\":\"Triathlon Bike\"},{\"1\":\"Dirt Jump\"},{\"1\":\"City\"},{\"1\":\"Cyclocross\"},{\"1\":\"Enduro\"},{\"1\":\"E-Mountain\"},{\"1\":\"All-Road\"},{\"1\":\"Endurance\"},{\"1\":\"E-City\"},{\"1\":\"Cross-Country\"},{\"1\":\"Touring\"},{\"1\":\"E-Gravel\"},{\"1\":\"Adventure\"},{\"1\":\"Downhill\"},{\"1\":\"Fat Bikes\"},{\"1\":\"E-Fitness\"},{\"1\":\"E-Trekking\"},{\"1\":\"E-Road\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nset.seed(seed = 1113)\nsplit_obj <- rsample::initial_split(bike_orderlines_tbl, prop   = 0.80, \n                                                       strata = \"category_2\")\n\n# Check if testing contains all category_2 values\nsplit_obj %>% training() %>% distinct(category_2)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"category_2\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"Triathlon Bike\"},{\"1\":\"Dirt Jump\"},{\"1\":\"City\"},{\"1\":\"Enduro\"},{\"1\":\"E-Mountain\"},{\"1\":\"Endurance\"},{\"1\":\"E-City\"},{\"1\":\"Touring\"},{\"1\":\"Cross-Country\"},{\"1\":\"E-Gravel\"},{\"1\":\"E-Fitness\"},{\"1\":\"Cyclocross\"},{\"1\":\"Downhill\"},{\"1\":\"E-Trekking\"},{\"1\":\"All-Road\"},{\"1\":\"Fat Bikes\"},{\"1\":\"Adventure\"},{\"1\":\"E-Road\"},{\"1\":\"Race\"},{\"1\":\"Trail\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nsplit_obj %>% testing() %>% distinct(category_2)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"category_2\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"Triathlon Bike\"},{\"1\":\"Race\"},{\"1\":\"E-City\"},{\"1\":\"Trail\"},{\"1\":\"Cross-Country\"},{\"1\":\"Touring\"},{\"1\":\"E-Mountain\"},{\"1\":\"Dirt Jump\"},{\"1\":\"All-Road\"},{\"1\":\"E-Fitness\"},{\"1\":\"Endurance\"},{\"1\":\"Enduro\"},{\"1\":\"E-Trekking\"},{\"1\":\"Downhill\"},{\"1\":\"City\"},{\"1\":\"Fat Bikes\"},{\"1\":\"Cyclocross\"},{\"1\":\"E-Gravel\"},{\"1\":\"Adventure\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# Assign training and test data\ntrain_tbl <- training(split_obj)\ntest_tbl  <- testing(split_obj)\n\n# remove spaces and dashes from the column names\ntrain_tbl <- train_tbl %>% set_names(str_replace_all(names(train_tbl), \" |-\", \"_\"))\ntest_tbl  <- test_tbl  %>% set_names(str_replace_all(names(test_tbl),  \" |-\", \"_\"))\n\ntrain_transformed_tbl <- bake(bike_recipe, new_data = train_tbl) #Create training and test data sets\ntest_transformed_tbl <- bake(bike_recipe, new_data = test_tbl) \n```\n:::\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-5_01e1ebe364af1861cc9b12006aa3f369'}\n\n```{.r .cell-code}\nmodel_01_linear_lm_simple <- linear_reg(mode = \"regression\") %>% #Create linear regression model\n    set_engine(\"lm\")\n```\n:::\n\n::: {.cell hash='02_supervised_ML_regression_cache/html/unnamed-chunk-6_7f655bf8707dff639e37518649d8b0ab'}\n\n```{.r .cell-code}\nlibrary(workflows)\n\n#Creating workflow\nworkflow <- workflow(preprocessor = NULL, spec = NULL) %>% \n  workflows::add_recipe(bike_recipe) %>% #Adding recipe\n  workflows::add_model(model_01_linear_lm_simple) #Adding model\n\nfitted_workflow <- fit(workflow, train_transformed_tbl) #Estimate model parameters from training set\n\nmetrics <- fitted_workflow %>%\n           predict(new_data = test_transformed_tbl) %>% #Predict from test data set\n           bind_cols(test_transformed_tbl %>% select(price)) %>%\n           yardstick::metrics(truth = price, estimate = .pred) %>% print() #Print yardstick metrics\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning in predict.lm(object = object$fit, newdata = new_data, type =\n#> \"response\"): prediction from a rank-deficient fit may be misleading\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n#> # A tibble: 3 x 3\n#>   .metric .estimator .estimate\n#>   <chr>   <chr>          <dbl>\n#> 1 rmse    standard      56.0  \n#> 2 rsq     standard       0.999\n#> 3 mae     standard       7.40\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}