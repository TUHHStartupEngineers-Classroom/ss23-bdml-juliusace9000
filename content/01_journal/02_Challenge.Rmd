# Challenge 2 - Supervised ML

```{r}
# Standard
library(tidyverse)
library(workflows)
# Modeling
library(parsnip)

# Preprocessing & Sampling
library(recipes)
library(rsample)

# Modeling Error Metrics
library(yardstick)

# Plotting Decision Trees
library(rpart.plot)

bike_orderlines_tbl <- readRDS("bike_orderlines.rds")
bike_features_tbl <- readRDS("bike_features_tbl.rds")
model_sales_tbl <- bike_orderlines_tbl %>%
    select(total_price, model, category_2, frame_material) %>%
    
    group_by(model, category_2, frame_material) %>%
    summarise(total_sales = sum(total_price)) %>%
    ungroup() %>%
    
    arrange(desc(total_sales))
library(recipes)
bike_recipe <- recipe(total_sales ~ frame_material + category_2, data = model_sales_tbl)

# Specify the data manipulation steps
bike_recipe <- bike_recipe %>%
  step_dummy(frame_material, category_2) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())

# Fit the recipe on the data
bike_recipe <- prep(bike_recipe, training = model_sales_tbl)
# run both following commands at the same time
set.seed(seed = 1113)
split_obj <- rsample::initial_split(bike_features_tbl, prop   = 0.80, 
                                                       strata = "category_2")

# Check if testing contains all category_2 values
split_obj %>% training() %>% distinct(category_2)
split_obj %>% testing() %>% distinct(category_2)

# Assign training and test data
train_tbl <- training(split_obj)
test_tbl  <- testing(split_obj)

train_transformed_tbl <- bake(bike_recipe, new_data = train_tbl)
test_transformed_tbl <- bake(bike_recipe, new_data = test_tbl)
bike_features_tbl_processed <- bake(bike_recipe, new_data = bike_features_tbl)
glimpse(bike_features_tbl_processed)

#model_01_linear_lm_simple <- linear_reg(mode = "regression") %>%
#    set_engine("lm") %>%
#    fit(price ~ category_2 + frame_material, data = train_transformed_tbl)

model <- lm(price ~ category_2 + frame_material, data = train_transformed_tbl)
# Create a workflow object
my_workflow <- workflow() %>%
  add_recipe(bike_recipe) %>%
  add_model(model_01_linear_lm_simple)
# Fit the workflow to the training data
fitted_workflow <- fit(my_workflow, data = train_transformed_tbl)
# Predict using the fitted workflow on the test data
predictions <- predict(fitted_workflow, new_data = test_transformed_tbl)

```